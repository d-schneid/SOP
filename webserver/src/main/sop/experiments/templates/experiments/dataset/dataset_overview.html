{% extends 'model_deletion.html' %}

{% block title %}Dataset Overview{% endblock %}

{% block heading %}
    <h2 class="mt-3 mb-3">Own Datasets</h2>
    <button class="btn-outline-dark btn mt-3 mb-3 ml-auto mr-3 dropdown-toggle" id="sortByButton"
            data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">Sort by {{ view.kwargs.sort }}</button>
    <ul class="dropdown-menu mr-5" aria-labelledby="sortByButton">
        <li><a href="{% url 'dataset_overview_sorted' 'name' %}" class="dropdown-item btn-secondary">Name</a></li>
        <li><a href="{% url 'dataset_overview_sorted' 'upload_date' %}" class="dropdown-item btn-secondary">Upload
            time</a></li>
    </ul>
    <a href="{% url 'dataset_upload' %}" class="mt-3 mb-3 btn btn-outline-dark">Upload dataset</a>
{% endblock heading %}

{% block card-header %}
    <h5 class="mb-0 w-80">
        <a class="btn-link btn-block text-white{% if not forloop.first %} collapsed{% endif %}"
           aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
           aria-controls="collapse_{{ model.pk }}">
            {{ model.display_name }}
        </a>
    </h5>
    <a class="text-white ml-auto dataset-status" id="dataset-status-{{ model.pk }}"></a>
{% endblock %}


{% block card-body %}
    <span style="white-space: pre">{{ model.description }}</span>

    {% if not model.has_finished and not model.has_error %}
        <div id="dataset-progress-div-{{ model.pk }}"></div>
    {% endif %}

    {% if model.has_finished and model.has_error %}
        <div class="alert alert-danger mt-4" role="alert">
            <b>The following Error occurred during cleaning:</b>
            <blockquote class="ml-3 mt-3">
                {{ model.get_error_message }}
            </blockquote>
        </div>
    {% endif %}

{% endblock %}

{% block edit %}
    <a href="{% url 'dataset_edit' model.pk %}"
       class="btn btn-warning mr-3"><i class="bi bi-pencil"></i> Edit</a>
    <div class="flex-grow-1">
        <a href="{% url 'dataset_download_uncleaned' model.pk %}" class="btn btn-info mr-3"><i
                class="bi bi-download"></i>
            Uncleaned</a>
        <a href="{% url 'dataset_download_cleaned' model.pk %}" class="btn btn-info mr-3"
           id="cleaned-download-{{ model.pk }}"
           style="visibility: {% if model.is_cleaned and not model.has_error %}visible{% else %}hidden{% endif %}"><i
                class="bi bi-download"></i> Cleaned</a>
    </div>
{% endblock %}

{% block error %}
    Dataset <b>{{ model.display_name }}</b> cannot be deleted, since it is used in these experiments:
{% endblock %}

{% block check %}
    Are you sure you want to delete dataset <b>{{ model.display_name }}</b>?
{% endblock %}

{% block delete %}
    <form action="{% url 'dataset_delete' model.pk %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger ml-auto mr-3"><i class="bi bi-trash"></i> Yes, Delete</button>
    </form>
{% endblock %}

{% block javascript %}
    <script>
        $(document).ready(function () {
            let statuses = document.getElementsByClassName("dataset-status")
            for (let i = 0; i < statuses.length; i++) {
                let status = statuses[i]
                let id = status.id.replace("dataset-status-", "")

                let progress_div = document.getElementById("dataset-progress-div-" + id)

                let $progress = $('<div id="dataset-progress-' + id + '" class="dataset-progress mt-3"></div>').appendTo(progress_div).append('<div class="progress-container"><div class="progress-status"></div><div class="bg-white border border-dark"><div class="progress-bar hidden progress-bar-striped progress-bar-animated bg-dark" style="width: 0%" role="progressbar" aria-valuemin="0" aria-valuemax="100">0%</div></div></div>');
                $progress.show();

                fetch($progress, id)
            }
        });

        function fetch($progress, id) {
            progress_url = "/dataset-status/"
            $.getJSON(progress_url, {'dataset_pk': Number(id)}, function (data, status) {
                status = document.getElementById("dataset-status-" + id)
                if (data.cleaning_status === "RUNNING") {
                    status.innerText = "cleaning in progress";
                    var progress = parseFloat(data.progress);
                    $progress.find('.progress-bar').css("width", progress * 100 + "%");
                    $progress.find('.progress-bar').html("cleaning " + parseInt(progress * 100) + '%');
                    setTimeout(function () {
                        return fetch($progress, id)
                    }, 1000)
                } else if (data.cleaning_status === "FINISHED") {
                    $progress.remove()
                    status.innerText = "cleaned"
                    document.getElementById("cleaned-download-" + id).style.visibility = "visible"
                } else if (data.cleaning_status === "FINISHED_WITH_ERROR") {
                    $progress.remove()
                    status.innerText = "cleaning failed"
                } else {
                    $progress.remove()
                    status.innerText = "SERVER ERROR"
                }
            });
        }
    </script>
{% endblock %}