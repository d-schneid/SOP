{% extends 'base.html' %}

{% block title %}
    Upload dataset
{% endblock %}

{% block content %}
    <form id="upload" method="post" onsubmit="openProgressBar(); return true;"
          enctype="multipart/form-data">{% csrf_token %}
        <div class="card shadow mt-4 mb-4">
            <div class="card-header bg-dark d-flex">
                <div>{{ form.display_name.errors }}</div>
                <div class="flex-fill">{{ form.display_name }}</div>
            </div>
            <div class="card-body show d-flex flex-column">
                <div>
                    {{ form.descirption.errors }}
                    <label for="{{ form.description.id_for_label }}">Description:</label>
                    {{ form.description }}
                </div>
                <div class="mt-3">
                    {{ form.path_original.errors }}
                    <label for="{{ form.path_original.id_for_label }}">Dataset File (.csv):</label>
                    {{ form.path_original }}
                </div>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <div class="d-flex mt-1 mb-1">
                        <a class="btn btn-dark" href="{% url "dataset_overview" %}">Cancel</a>
                        <button class="btn btn-success ml-auto" type="submit">Create</button>
                    </div>
                </li>
            </ul>
        </div>
    </form>
    <script type="text/javascript">
        interval = null;

        function openProgressBar() {
            /* generate random progress-id */
            uuid = "";
            for (i = 0; i < 32; i++) {
                uuid += Math.floor(Math.random() * 16).toString(16);
            }
            /* patch the form-action tag to include the progress-id */
            document.getElementById("upload").action += '?X-Progress-ID=' + uuid;


            /* show progress bar */
            var $progress = $('<div id="upload-progress" class="upload-progress mt-3"></div>').appendTo(".card-body").append('<div class="progress-container"><div class="progress-status">Preparing upload...</div><div class="bg-white border border-dark"><div class="progress-bar hidden progress-bar-striped progress-bar-animated bg-dark" style="width: 0%" role="progressbar" aria-valuemin="0" aria-valuemax="100">0%</div></div></div>');
            $progress.show();

            /* call the progress-updater periodically */
            interval = window.setInterval(
                function () {
                    fetch(uuid, $progress);
                },
                100
            );
        }

        // Add upload progress for multipart forms.
        function fetch(uuid, $progress) {
            var progress_url = '/upload_progress/'; // ajax view serving progress info
            $.getJSON(progress_url, {'X-Progress-ID': uuid}, function (upload, status) {
                var width = $progress.find('.upload-container').width();
                if (upload.state == "starting") {
                    console.log("starting")
                    $progress.find('.progress-bar').css("width", 0 + "%");
                    $progress.find('.progress-status').html('Starting upload...');
                } else if (upload.state == "uploading") {
                    console.log("uploading")
                    var progress = parseInt(upload.received) / parseInt(upload.size);
                    $progress.find('.progress-bar').css("width", progress * 100 + "%");
                    $progress.find('.progress-bar').html(parseInt(progress * 100) + '%');
                    $progress.find('.progress-bar').width(width);
                    $progress.find('.progress-status').html('Uploading...');
                } else if (upload.state == "done") {
                    console.log("done")
                    $progress.find('.progress-bar').css("width", 100 + "%");
                    $progress.find('.progress-status').html('Upload finished...');
                    $progress.find('.progress-bar').html('Saving dataset, this may take a few moments...');
                    window.clearTimeout(interval)
                }
            });
        }
    </script>
{% endblock %}