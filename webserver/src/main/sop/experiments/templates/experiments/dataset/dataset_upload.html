{% extends 'base.html' %}

{% block title %}
    Upload dataset
{% endblock %}

{% block content %}
    <div class="upload-container">
        <form id="upload" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ form.as_p }}
            <div class="d-flex" id="buttons">
                <a href="{% url 'dataset_overview' %}" class="btn btn-dark">Cancel</a>
                <input class="btn btn-dark ml-auto" type="submit" value="Save">
            </div>
        </form>
    </div>

    <script type="text/javascript">
        // Generate 32 char random uuid
        function gen_uuid() {
            var uuid = ""
            for (var i = 0; i < 32; i++) {
                uuid += Math.floor(Math.random() * 16).toString(16);
            }
            return uuid
        }

        // Add upload progress for multipart forms.
        $(function () {
            $('#upload').submit(function () {
                // Prevent multiple submits
                if ($.data(this, 'submitted')) return false;

                var freq = 100; // freqency of update in ms
                var uuid = gen_uuid(); // id for this upload so we can fetch progress info.
                var progress_url = '/upload_progress/'; // ajax view serving progress info

                // Append X-Progress-ID uuid form action
                this.action += (this.action.indexOf('?') == -1 ? '?' : '&') + 'X-Progress-ID=' + uuid;

                var $progress = $('<div id="upload-progress" class="upload-progress mt-3"></div>').appendTo(".upload-container").append('<div class="progress-container">Upload progress: <div class="bg-white border border-dark"><div class="progress-bar hidden progress-bar-striped progress-bar-animated bg-dark" style="width: 0%" role="progressbar" aria-valuemin="0" aria-valuemax="100">0%</div></div></div>');

                // Update progress bar
                function update_progress_info() {
                    $progress.show();
                    $.getJSON(progress_url, {'X-Progress-ID': uuid}, function (data, status) {
                        if (data) {
                            var progress = parseInt(data.uploaded) / parseInt(data.length);
                            var width = $progress.find('.upload-container').width()
                            $progress.find('.progress-bar').css("width", progress * 100 + "%");
                            $progress.find('.progress-bar').html(parseInt(progress * 100) + '%');
                            $progress.find('.progress-bar').width(width)
                            window.setTimeout(update_progress_info, freq);
                        } else {
                            var width = $progress.find('.upload-container').width()
                            $progress.find('.progress-bar').css("width", 100 + "%");
                            $progress.find('.progress-bar').html('Saving dataset, this may take a few moments...');
                            $progress.find('.progress-bar').width(width)
                        }
                    });
                };
                window.setTimeout(update_progress_info, freq);

                $.data(this, 'submitted', true); // mark form as submitted.
            });
        });
    </script>
    <!---
    <div class="upload-progress" id="upload-progress">
        <div class="progress-container">Upload progress:
            <div class="progress-bar hidden progress-bar-striped" role="progressbar" style="width: 50%"
                 aria-valuemin="0" aria-valuemax="100">50%
            </div>
        </div>
    </div>
    --->
{% endblock %}